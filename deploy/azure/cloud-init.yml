#cloud-config
# KISS Mail - Azure Cloud Init Configuration

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx

runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Create data directory
  - mkdir -p /opt/kiss-mail/data
  - chown -R 1000:1000 /opt/kiss-mail
  
  # Generate API key
  - export API_KEY=$(openssl rand -hex 32)
  - echo "API_KEY=$API_KEY" > /opt/kiss-mail/.env
  
  # Run KISS Mail container
  - |
    docker run -d \
      --name kiss-mail \
      --restart unless-stopped \
      -p 25:2525 \
      -p 587:2525 \
      -p 143:1143 \
      -p 110:1100 \
      -p 8080:8080 \
      -p 8025:8025 \
      -v /opt/kiss-mail/data:/data \
      -e KISS_MAIL_DOMAIN="${domain}" \
      -e KISS_MAIL_API_KEY=$API_KEY \
      -e KISS_MAIL_WEB_BIND=0.0.0.0 \
      -e KISS_MAIL_API_BIND=0.0.0.0 \
      -e RUST_LOG=info \
      ghcr.io/pegasusheavy/kiss-mail:latest
  
  # Configure Nginx
  - |
    cat > /etc/nginx/sites-available/kiss-mail << 'EOF'
    server {
        listen 80;
        server_name _;
        
        location /admin {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /api {
            proxy_pass http://127.0.0.1:8025;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location / {
            return 301 /admin;
        }
    }
    EOF
  - ln -sf /etc/nginx/sites-available/kiss-mail /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl enable nginx
  - systemctl restart nginx
  
  # Save credentials
  - |
    PUBLIC_IP=$(curl -s -H Metadata:true "http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=2021-02-01&format=text")
    cat > /opt/kiss-mail/credentials.txt << EOF
    KISS Mail Server Credentials
    =============================
    Domain: ${domain}
    API Key: $API_KEY
    Web Admin: http://$PUBLIC_IP/admin
    
    Generated: $(date)
    EOF
  - chmod 600 /opt/kiss-mail/credentials.txt

final_message: "KISS Mail setup complete after $UPTIME seconds"
